# Railway Log Monitor - Hybrid Approach Implementation Plan

## Overview

Build a lightweight **intelligence-service** that runs on Railway, polls logs, detects errors, and creates GitHub issues with a special label that triggers Claude Code to analyze and provide fix suggestions.

## Hybrid Architecture

```
Railway Logs â†’ Intelligence Service (error detection)
â†’ Creates GitHub issue with "needs-claude-analysis" label
â†’ claude-issue-handler.yml GitHub Action triggers
â†’ Claude Code analyzes logs + codebase context
â†’ Claude comments on issue with root cause + fix suggestions
â†’ Intelligence Service marks issue as "analyzed"
```

## Key Benefits

âœ… **No Claude API key needed** - Uses existing Claude Code subscription
âœ… **Leverages existing MCP servers** - Railway + GitHub already configured
âœ… **Separation of concerns** - Detection vs Analysis
âœ… **Uses existing workflow** - Extends claude-issue-handler.yml
âœ… **Cost effective** - No Anthropic API charges
âœ… **Better context** - Claude Code has full codebase access

## Current Application Logging

Based on code analysis, the backend logs:

**Error Handler** (`errorHandler.ts`):
```typescript
console.error('Error:', {
  message,
  statusCode,
  stack: err.stack,
  url: req.url,
  method: req.method,
});
```

**Other Console Logs**:
- `console.log()` - Info (CORS config, server startup, admin ops)
- `console.warn()` - Warnings (geocoding issues, missing API keys)
- `console.error()` - Errors (email service, scraper, geocoding failures)

**Railway captures**: All stdout/stderr with automatic timestamps

## Intelligence Service Components

### 1. Railway Log Poller (`services/railwayLogPoller.ts`)
- Polls Railway GraphQL API every 10 minutes
- Fetches deployment logs for backend, frontend, scraper
- Filters for ERROR level messages
- Groups related errors (within 5-minute window)

### 2. Error Detector (`services/errorDetector.ts`)
- Parses Railway log format
- Detects error patterns:
  - Lines with `console.error` output
  - Stack traces
  - Known error keywords (ECONNREFUSED, timeout, failed, etc.)
- Groups consecutive related errors
- Generates error signatures for deduplication

### 3. GitHub Issue Creator (`services/githubIssueCreator.ts`)
- Creates issues with special format for Claude analysis
- Adds label: `needs-claude-analysis`
- Includes: error logs, timestamps, service info, Railway links
- Checks for duplicates before creating

### 4. State Manager (`services/stateManager.ts`)
- Tracks last check time per service
- Stores created issues to prevent duplicates
- Marks issues as "analyzed" after Claude responds

## Simplified Database Schema

Only 2 tables needed (much simpler than original plan):

```prisma
model LogCheckpoint {
  id            String   @id @default(cuid())
  serviceName   String   @unique
  lastCheckTime DateTime
  updatedAt     DateTime @updatedAt
  @@map("log_checkpoints")
}

model DetectedIssue {
  id                String   @id @default(cuid())
  githubIssueNumber Int      @unique
  errorSignature    String   @unique
  serviceName       String
  errorMessage      String   @db.Text
  firstSeen         DateTime
  lastSeen          DateTime
  occurrenceCount   Int      @default(1)
  claudeAnalyzed    Boolean  @default(false)
  resolved          Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  @@map("detected_issues")
}
```

## GitHub Issue Template (for Claude)

```markdown
## ðŸ¤– Automated Error Detection

An error was detected in the **{serviceName}** service logs.

### Error Details
- **Service**: {backend/frontend/scraper}
- **First Seen**: {timestamp}
- **Occurrences**: {count}
- **Deployment**: [{deploymentId}]({railway_logs_url})

### Error Logs
```
{filtered error logs with context}
```

### Railway Context
- [View Full Logs]({railway_logs_url})
- [View Service]({railway_service_url})
- Environment: production

---

@claude Please analyze these error logs and provide:
1. Root cause analysis
2. Severity assessment
3. Specific fix suggestions with code examples
4. Prevention recommendations

*Auto-generated by Intelligence Service*
```

**Labels**: `needs-claude-analysis`, `automated`, `railway-logs`, `{service}`

## Modified GitHub Action

Update `.github/workflows/claude-issue-handler.yml` to handle log analysis issues:

```yaml
name: Claude Issue Handler

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  claude-analyze:
    if: contains(github.event.issue.labels.*.name, 'needs-claude-analysis')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Claude Code Analysis
        uses: anthropics/anthropic-ai/claude-code@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          railway-api-token: ${{ secrets.RAILWAY_API_TOKEN }}

      - name: Mark as analyzed
        run: |
          gh issue edit ${{ github.event.issue.number }} \
            --remove-label "needs-claude-analysis" \
            --add-label "claude-analyzed"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## Service Structure (Simplified)

```
intelligence-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ server.ts                    # Express + health check
â”‚   â”œâ”€â”€ cron.ts                      # 10-minute polling
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ railwayLogPoller.ts      # Fetch logs from Railway
â”‚   â”‚   â”œâ”€â”€ errorDetector.ts         # Parse + detect errors
â”‚   â”‚   â”œâ”€â”€ githubIssueCreator.ts    # Create issues for Claude
â”‚   â”‚   â””â”€â”€ stateManager.ts          # Database tracking
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”œâ”€â”€ logs.ts                  # Railway log types
â”‚   â”‚   â””â”€â”€ errors.ts                # Error detection types
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ errorPatterns.ts         # Common error regex
â”‚       â””â”€â”€ logParser.ts             # Parse Railway log format
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma                # Minimal schema (2 models)
â”œâ”€â”€ railway.toml
â”œâ”€â”€ package.json
â””â”€â”€ .env.example
```

## Dependencies (Minimal)

```json
{
  "dependencies": {
    "@prisma/client": "^6.19.0",
    "axios": "^1.7.0",
    "express": "^4.18.2",
    "graphql-request": "^6.1.0",
    "node-cron": "^3.0.3",
    "prisma": "^6.19.0",
    "dotenv": "^16.3.1"
  },
  "devDependencies": {
    "@types/express": "^4.17.20",
    "@types/node": "^20.8.10",
    "@types/node-cron": "^3.0.11",
    "typescript": "^5.2.2"
  }
}
```

**No `@anthropic-ai/sdk` needed!**

## Environment Variables (Simplified)

```bash
# Database
DATABASE_URL="postgresql://..."  # Shared Postgres

# Railway API
RAILWAY_API_TOKEN="..."          # For fetching logs
RAILWAY_PROJECT_ID="c10d6b64-1df1-4dcc-958c-f9d038b591a7"
RAILWAY_ENVIRONMENT_ID="..."

# Service IDs
BACKEND_SERVICE_ID="..."
FRONTEND_SERVICE_ID="..."
SCRAPER_SERVICE_ID="..."

# GitHub (for issue creation only)
GITHUB_TOKEN="..."               # PAT with issues:write
GITHUB_REPO_OWNER="findabar"
GITHUB_REPO_NAME="MichelinCompare"

# Config
POLLING_INTERVAL_MINUTES="10"
NODE_ENV="production"
PORT=3003
```

**No ANTHROPIC_API_KEY needed!**

## Workflow Example

### 1. Error Occurs in Backend
```
[2026-01-19T15:30:45Z] Error: {
  message: 'connect ECONNREFUSED 127.0.0.1:5432',
  statusCode: 500,
  stack: 'Error: connect ECONNREFUSED...',
  url: '/api/restaurants',
  method: 'GET'
}
```

### 2. Intelligence Service Detects (10 min later)
- Polls Railway logs
- Finds error logs from last 10 minutes
- Groups 3 related database connection errors
- Generates signature: `db-connection-refused-5432`
- Checks database: no existing issue with this signature

### 3. Creates GitHub Issue #456
```markdown
## ðŸ¤– Automated Error Detection

An error was detected in the **backend** service logs.

### Error Details
- Service: backend
- First Seen: 2026-01-19T15:30:45Z
- Occurrences: 3
- Deployment: [abc123](railway_url)

### Error Logs
```
[15:30:45] Error: { message: 'connect ECONNREFUSED 127.0.0.1:5432', ... }
[15:30:46] Error: { message: 'connect ECONNREFUSED 127.0.0.1:5432', ... }
[15:30:47] Error: { message: 'connect ECONNREFUSED 127.0.0.1:5432', ... }
```

@claude Please analyze these error logs...
```

Labels: `needs-claude-analysis`, `automated`, `railway-logs`, `backend`

### 4. GitHub Action Triggers
- Detects issue #456 with `needs-claude-analysis` label
- Launches Claude Code
- Claude has full context: issue description + entire codebase + MCP servers

### 5. Claude Analyzes and Comments
```markdown
## Analysis Results

### Root Cause
The backend service cannot connect to PostgreSQL. This appears to be a DATABASE_URL
configuration issue or the Postgres service is down.

### Severity
**CRITICAL** - Application cannot serve requests without database access.

### Suggested Fix

1. Check Railway service status for PostgreSQL:
```bash
railway status --service Postgres
```

2. Verify DATABASE_URL in backend service variables matches Postgres service URL

3. Check service linking in Railway dashboard

4. If Postgres was recently restarted, the backend may need restart:
```bash
railway restart --service backend
```

### Code to Check
- [backend/prisma/schema.prisma](link) - Verify datasource URL
- [backend/.env.example](link) - Ensure DATABASE_URL format is correct

### Prevention Tips
- Add database connection retry logic with exponential backoff
- Implement health check that alerts before serving traffic
- Consider connection pooling configuration

Let me know if you'd like me to implement the retry logic!
```

### 6. Intelligence Service Updates
- Detects Claude's comment
- Marks issue as `claudeAnalyzed` in database
- Adds label `claude-analyzed`
- Removes label `needs-claude-analysis`

### 7. If Error Recurs
- Detects same error signature
- Comments on existing issue #456:
  ```
  **Error recurred**
  - Time: 2026-01-19T16:45:22Z
  - Occurrences: 2 more

  The issue persists. Please prioritize investigation.
  ```

## Error Detection Patterns

```typescript
const ERROR_PATTERNS = [
  // Database
  { pattern: /ECONNREFUSED.*5432|Connection.*refused.*postgres/i,
    severity: 'critical', category: 'database' },

  // Auth
  { pattern: /jwt.*expired|invalid.*token|JsonWebTokenError/i,
    severity: 'medium', category: 'auth' },

  // Prisma
  { pattern: /prisma.*migration.*failed|schema.*mismatch/i,
    severity: 'high', category: 'database' },

  // CORS
  { pattern: /CORS.*blocked|Access-Control-Allow-Origin/i,
    severity: 'high', category: 'network' },

  // Puppeteer
  { pattern: /puppeteer.*timeout|navigation.*timeout/i,
    severity: 'medium', category: 'scraper' },

  // Memory
  { pattern: /ENOMEM|heap out of memory/i,
    severity: 'critical', category: 'performance' },

  // Rate limits
  { pattern: /rate limit.*exceeded|too many requests|429/i,
    severity: 'medium', category: 'api' },
];
```

## Cost Analysis

### Railway Hosting
- Memory: ~128MB (much lighter, no Claude SDK)
- Network: ~500MB/month (just Railway API + GitHub API)
- **Cost**: $5/month

### Claude API
- **Cost**: $0/month (uses existing Claude Code subscription)

### GitHub API
- **Cost**: Free (5000 requests/hour)

### Total: ~$5/month ðŸŽ‰

## Implementation Steps

1. **Create service structure**
   - Directory layout
   - package.json
   - TypeScript config

2. **Implement Railway log poller**
   - GraphQL client
   - Fetch deployment logs
   - Filter by timestamp

3. **Implement error detector**
   - Log parsing
   - Pattern matching
   - Error grouping
   - Signature generation

4. **Implement GitHub issue creator**
   - Issue template formatting
   - Label management
   - Deduplication check

5. **Implement state manager**
   - Prisma schema
   - Database queries
   - Checkpoint tracking

6. **Add Express server**
   - Health check
   - Manual trigger endpoint
   - Status endpoint

7. **Update GitHub Action**
   - Modify claude-issue-handler.yml
   - Add label-based trigger
   - Add "analyzed" label after Claude responds

8. **Deploy to Railway**
   - Set environment variables
   - Run migrations
   - Test end-to-end

## Verification Steps

1. **Deploy intelligence-service to Railway**
2. **Inject test error in backend**:
   ```typescript
   // Temporarily add to a route:
   throw new Error('TEST ERROR: Database connection test');
   ```
3. **Wait 10 minutes or trigger manually**:
   ```bash
   curl -X POST https://intelligence-service.railway.app/trigger-check
   ```
4. **Verify GitHub issue created** with `needs-claude-analysis` label
5. **Verify GitHub Action triggers** and Claude comments
6. **Verify label changes** to `claude-analyzed`
7. **Inject same error** again
8. **Verify comment added** to existing issue (no new issue)

## Success Criteria

âœ… Intelligence service deploys to Railway
âœ… Polls Railway logs every 10 minutes
âœ… Detects error-level logs
âœ… Creates GitHub issues with special label
âœ… GitHub Action triggers on label
âœ… Claude Code analyzes and comments with fixes
âœ… Prevents duplicate issues
âœ… Comments on existing issues when errors recur
âœ… Cost: ~$5/month (no Claude API charges)
âœ… No manual API key management for Claude

## Next Steps

1. Create intelligence-service directory
2. Implement Railway log poller
3. Implement error detector
4. Implement GitHub issue creator
5. Set up database with minimal schema
6. Update claude-issue-handler.yml workflow
7. Deploy and test
